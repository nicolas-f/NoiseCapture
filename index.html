<html>

<head>
    <title>NoiseCapture interactive community map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="css/languages.min.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/cluster.css" />
    <link rel="stylesheet" href="css/jqcloud.css" />
    <link href="css/flag-icon.min.css" rel="stylesheet">
    <link href="css/leaflet-search.min.css" rel="stylesheet" />
    <link href="css/L.Control.MousePosition.css" rel="stylesheet" />
    <link href="css/time_donut.css" rel="stylesheet">
    <link href="http://fontawesome.io/assets/font-awesome/css/font-awesome.css" rel="stylesheet">
    <script src="js/leaflet.js"></script>
</head>

<body>
  <div id="statistics">
                  <h1 class="sidebar-header">Statistics</h1><span class="sidebar-close"><font color="white"><i class="fa fa-caret-left fa-2x" ></i></font></span>

                  <h4>Summary</h4>

                      <table class="table">
                     <thead>
                       <tr>
                         <th></th>
                         <th>Last 7 days</th>
                         <th>Last 7 weeks</th>
                         <th>All activity</th>
                       </tr>
                     </thead>
                     <tbody>
                       <tr>
                         <td>New contributors</td>
                         <td id="statistics_week_new_contributors"></td>
                         <td id="statistics_7weeks_new_contributors"></td>
                         <td id="statistics_total_contributors"></td>
                       </tr>
                       <tr>
                         <td>Number of tracks</td>
                         <td id="statistics_week_new_tracks_count"></td>
                         <td id="statistics_7weeks_new_tracks_count"></td>
                         <td id="statistics_total_tracks"></td>
                       </tr>
                       <tr>
                         <td>Duration</td>
                         <td id="statistics_week_new_tracks_duration"></td>
                         <td id="statistics_7weeks_new_tracks_duration"></td>
                         <td id="statistics_total_tracks_duration"></td>
                       </tr>
                     </tbody>
                   </table>
                 <h4>Activity of the last 7 weeks</h4>
                  <div style="height: 300px">
                    <canvas id="statistics_country_weeks"></canvas>
                  </div>
                 <h4>Contribution per country</h4>
                  <div>
                    <canvas id="statistics_country_contribution"></canvas>
                    <canvas id="statistics_country_contribution_count"></canvas>
                  </div>
                  <h4>Distributions</h4>
                   <div>
                    <canvas id="statistics_length_distribution"></canvas>
                      <canvas id="statistics_tags_per_track"></canvas>
                  </div>
                  <h4>Tags</h4>
                  <div id="statistics_world_tags" style="width: 100%; height: 350px;"></div>

  </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script type="text/javascript">window.liveSettings={api_key:"4c31aac0398149cf971660ee00d6106b"};</script>
    <script type="text/javascript" src="//cdn.transifex.com/live.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jqcloud-1.0.4.min.js"></script>
    <script>
    var colorMap = ["#a6cee3", "#ffffbf" , "#b2df8a" , "#fb9a99" , "#fdbf6f" , "#ff7f00" , "#cab2d6" , "#6a3d9a"
                    , "#ffff99" , "#b15928"];

    function length_to_dd_hh_mm_ss(seconds) {
      if (seconds == 0) {
        return "0s";
      }
      // calculate (and subtract) whole days
      var days = Math.floor(seconds / 86400);
      seconds -= days * 86400;
      // calculate (and subtract) whole hours
      var hours = Math.floor(seconds / 3600) % 24;
      seconds -= hours * 3600;
      // calculate (and subtract) whole minutes
      var minutes = Math.floor(seconds / 60) % 60;
      seconds -= minutes * 60;
      // what's left is seconds
      var seconds = seconds % 60; // in theory the modulus is not required
      if (days > 0) {
        return Transifex.live.translateText("{days}d {hours}h{minutes}m", { days: days, hours:hours, minutes:minutes})
      } else if (hours > 0) {
        return Transifex.live.translateText("{hours}h{minutes}m", { hours:hours, minutes:minutes})
      } else if (minutes > 0) {
        return Transifex.live.translateText("{minutes}m{seconds}s", { hours:hours, minutes:minutes, seconds:seconds})
      } else {
        return Transifex.live.translateText("{seconds}s", {seconds:seconds})
      }
    }
    function loadStatistics() {
      // Test if statistics are aloready loaded
      if (typeof window.statisticsCountryContributionBar !== 'undefined') {
        return;
      }
      // Retrieve stored statistics file
      $.ajax({
        url: "http://data.noise-planet.org/statistics.json",
        type: "GET",
        crossDomain: true,
        cache: false,
        dataType: "json",
        success: function(data) {
          document.getElementById('statistics_week_new_contributors').innerHTML = data["week_new_contributors"];
          document.getElementById('statistics_week_new_tracks_count').innerHTML = data["week_new_tracks_count"];
          document.getElementById('statistics_week_new_tracks_duration').innerHTML = length_to_dd_hh_mm_ss(data["week_new_tracks_duration"]);
          document.getElementById('statistics_7weeks_new_contributors').innerHTML = data["7weeks_new_contributors"];
          document.getElementById('statistics_7weeks_new_tracks_count').innerHTML = data["7weeks_new_tracks_count"];
          document.getElementById('statistics_7weeks_new_tracks_duration').innerHTML = length_to_dd_hh_mm_ss(data["7weeks_new_tracks_duration"]);
          document.getElementById('statistics_total_contributors').innerHTML = data["total_contributors"];
          document.getElementById('statistics_total_tracks').innerHTML = data["total_tracks"];
          document.getElementById('statistics_total_tracks_duration').innerHTML = length_to_dd_hh_mm_ss(data["total_tracks_duration"]);
          // Load tags
          // Set tooltipItem
          // <a data-placement="right" style="cursor: pointer;" data-toggle="tooltip" title="" onclick="onomap.goToHistory(3)" data-original-title="Vannes, Bretagne, France"><span class="flag-icon flag-icon-fr"></span></a>
          for(var idTag=0; idTag < data["tags"].length; idTag++) {
            data["tags"][idTag]["html"] = {'data-original-title': data["tags"][idTag]["weight"]+" tracks", 'data-toggle':"tooltip", 'data-placement':"top", title:""}
          }
          $("#statistics_world_tags").jQCloud(data["tags"]);
          // Load contribution per country
          // Sort arrays by track_length
          var name_sorted = data["countries"]["names"].slice()
          var count_sorted = data["countries"]["track_length"].slice()
          window.statisticsCountryContributionBar =  new Chart(document.getElementById("statistics_country_contribution"), {
            type: 'horizontalBar',
            data: {
              labels: name_sorted.sort(function(a,b) {return data["countries"]["track_length"][data["countries"]["names"].indexOf(b)] - data["countries"]["track_length"][data["countries"]["names"].indexOf(a)]}).slice(0, Math.min(8, data["countries"]["names"].length)),
              datasets: [{
                  label: Transifex.live.translateText('Duration'),
                  backgroundColor: "#d1e5f0",
                  borderColor: "#67a9cf",
                  borderWidth: 1,
                  data: count_sorted.sort(function(a, b){return b-a}).slice(0, Math.min(8, data["countries"]["track_length"].length))
              }]
            },
            options: {
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    rectangle: {
                        borderWidth: 2,
                    }
                },
                responsive: true,
                tooltips: {
                  mode: 'index',
                  intersect: true,
                  callbacks: {
                    label: function(tooltipItem, data) {
                      return data.datasets[tooltipItem.datasetIndex].label + ': ' + length_to_dd_hh_mm_ss(tooltipItem.xLabel);
                    }
                  }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: Transifex.live.translateText('Measurements duration')
                },
                scales: {
                  xAxes: [{
                    time: {
                      unit: 'second'
                    },
                    ticks: {
                      userCallback: function(v) {
                        return length_to_dd_hh_mm_ss(v)
                      }
                    }
                  }]
                }
            }
          });
          // Load contribution per country
          window.statistics_country_contribution_count =  new Chart(document.getElementById("statistics_country_contribution_count"), {
            type: 'horizontalBar',
            data: {
              labels: data["countries"]["names"].slice(0, Math.min(8, data["countries"]["names"].length)),
              datasets: [{
                  label: Transifex.live.translateText('Measurements'),
                  backgroundColor: "#d1e5f0",
                  borderColor: "#67a9cf",
                  borderWidth: 1,
                  data: data["countries"]["total_tracks"].slice(0, Math.min(8, data["countries"]["total_tracks"].length))
              }]
            },
            options: {
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    rectangle: {
                        borderWidth: 2,
                    }
                },
                responsive: true,
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: Transifex.live.translateText('Number of measurements')
                }
            }
          });
          // Load country/week stack bar
          window.statisticsCountryWeeksBar = new Chart(document.getElementById("statistics_country_weeks"), {
            type: 'bar',
            data: data["week_tracks"],
            options: {
              maintainAspectRatio: false,
              title: {
                display: true,
                text: Transifex.live.translateText("Measurement duration by week")
              },
              tooltips: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + ': ' + length_to_dd_hh_mm_ss(tooltipItem.yLabel);
                  }
                }
              },
              responsive: true,
              scales: {
                xAxes: [{
                  stacked: true,
                }],
                yAxes: [{
                  stacked: true,
                  //type: "logarithmic",
                  time: {
                    unit: 'second'
                  },
                  ticks: {
                    userCallback: function(v) {
                      return length_to_dd_hh_mm_ss(v)
                    }
                  }
                }]
              }
            }
          });
          // Load measurementslength distribution
          // Bar chart
          new Chart(document.getElementById("statistics_length_distribution"), {
              type: 'bar',
              data: {
                labels: data["distribution_measurements"]["ranges"],
                datasets: [
                  {
                    label: Transifex.live.translateText("Measurement count"),
                    backgroundColor: "#d1e5f0",
                    borderColor: "#67a9cf",
                    data: data["distribution_measurements"]["total_tracks"]
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: Transifex.live.translateText('Measurement duration distribution')
                }
              }
          });
          // Load measurementslength distribution
          // Bar chart
          new Chart(document.getElementById("statistics_tags_per_track"), {
              type: 'bar',
              data: {
                labels: data["tags_per_track"]["tag_count"],
                datasets: [
                  {
                    label: Transifex.live.translateText("Measurement count"),
                    backgroundColor: "#d1e5f0",
                    borderColor: "#67a9cf",
                    data: data["tags_per_track"]["track_count"],
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: Transifex.live.translateText('Distribution of tags per measurement')
                },
                tooltips: {
                  callbacks: {
                    title: function(tooltipItems, data) {
                        //Return value for title
                        return tooltipItems[0].xLabel + '  tags';
                    }
                  }
                }
              }
          });
          // Have to call this for tags clouds toolips to work
          // do not remove
          setTimeout(function() { $('[data-toggle="tooltip"]').tooltip(); }, 1000);
        }
      });
    }

    loadStatistics();
    </script>
</body>

</html>
