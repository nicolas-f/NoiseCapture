<html>

<head>
    <title>NoiseCapture interactive community map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="css/languages.min.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/cluster.css" />
    <link rel="stylesheet" href="css/jqcloud.css" />
    <link href="css/flag-icon.min.css" rel="stylesheet">
    <link href="css/leaflet-search.min.css" rel="stylesheet" />
    <link href="css/L.Control.MousePosition.css" rel="stylesheet" />
    <link href="css/time_donut.css" rel="stylesheet">
    <link href="http://fontawesome.io/assets/font-awesome/css/font-awesome.css" rel="stylesheet">
    <script src="js/leaflet.js"></script>
</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-home"></i></a></li>
                <li><a href="#hexainfo" role="tab"><i class="fa fa-pie-chart"></i></a></li>
                <li><a href="#history" role="tab" onclick="setTimeout(doHistoRefresh(),200)"><i class="fa fa-history"></i></a></li>
                <li><a href="#statistics" role="tab"  onclick="setTimeout(loadStatistics,200)"><i class="fa fa-line-chart"></i></a></li>
            </ul>
            <ul role="tablist">
                <li class="disabled">
                    <a href="#help" role="tab">
                        <i class="fa fa-question-circle"></i>
                        <li><a href="#code" role="tab"><i class="fa fa-code"></i></a></li>
                        <li><a href="#about" role="tab"><i class="fa fa-copyright"></i></a></li>
                        <hr style='margin-bottom=-1em'>
                        <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>
        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">Home<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h1>How sounds your environment?</h1>
                <h2>What is this website?</h2>
                <div class="text_description">According to <a href="http://www.euro.who.int/en/health-topics/environment-and-health/noise" target="_blank">World Health Organization</a>, <cite>"the excessive noise seriously harms human health and interferes with people's daily activities at school, at work, at home and during leisure time. It can disturb sleep, cause cardiovascular and psychophysiological effects, reduce performance and provoke annoyance responses and changes in social behaviour".</cite></div>
                <br>
                <div class="text_description_b">The aim of this website is to give to people, whether citizens or experts, the opportunity to <b>evaluate their noise environment through objective and subjective indicators.</b></div>
                <br><a target="_blank" href="https://twitter.com/search?q=%40Noise_planet&src=typd"><img title="Follow @Noise_Planet" alt="Follow @Noise_Planet" src="https://img.shields.io/twitter/follow/Noise_Planet.svg?style=social&amp;label=Follow" /></a>
                <h2>The NoiseCapture approach</h2>
                <div class="text_description">Nowadays, especially in response to national, European and international rules, noise maps offered by government organizations, are made on the basis of numerical simulations, with the limitations we know them, and which result in two
                    forms: a "lack" of realism of the state of noise in the environment, as well as a lack of representation of the environment as it is perceived.</div>
                <br>
                <div class="centered"><img align="left" src="img/noisecapture_logo.png" alt="logo" class="logo" width="20%"></div>
                <div class="text_description_b">Instead of using complex numerical simulation approach, the <b>NoiseCapture research project</b> propose to evaluate and represent the environmental noise with the help of citizens, <b>following a participative approach, using a smartphone application</b>.</div>
                <h2>How does-it work?</h2>
                <h3>Explore the noisemaps</h3>
                <div class="text_description">Navigate on the map, select the layers, explore your noise environment...</div>
                <h3>Contribute to the noisemaps</h3>
                <div class="text_description">Download the NoiseCapture Android App, realize measurements and transfer data to the community...</div>
                <div class="centered">
                    <a href="https://play.google.com/store/apps/details?id=org.noise_planet.noisecapture"><img style="width: 164px; height: 63px;" alt="Get it on Google Play" src="https://play.google.com/intl/en_us/badges/images/generic/en_badge_web_generic.png"></a><br>
                </div>
            </div>
            <div class="sidebar-pane" id="history">
                <h1 class="sidebar-header">History<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h3>Last measurements
          <a><i class="fa fa-refresh fa-spin fa-fw margin-bottom" onclick="doHistoRefresh()"></i>
          <span class="sr-only">Refresh</span></a></h3>
                <div id="measures_log"></div>
            </div>
            <div class="sidebar-pane" id="statistics">
                <h1 class="sidebar-header">Statistics<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
               <h3>Since 7 days</h3>
               <p class='attribute_label'>New contributors:</p><pre id="statistics_week_new_contributors"></pre>
               <p class='attribute_label'>Number of tracks:</p><pre id="statistics_week_new_tracks_count"></pre>
               <p class='attribute_label'>Duration:</p><pre id="statistics_week_new_tracks_duration"></pre>
               <h3>Activity</h3>
                <div style="height: 300px">
                  <canvas id="statistics_country_weeks"></canvas>
                </div>
               <h3>All data</h3>
               <p class='attribute_label'>Approximate number of contributors:</p><pre id="statistics_total_contributors"></pre>
               <p class='attribute_label'>Total number of tracks:</p><pre id="statistics_total_tracks"></pre>
               <p class='attribute_label'>Total duration:</p><pre id="statistics_total_tracks_duration"></pre>
               <h4>Tags Cloud</h4>
               <div id="statistics_world_tags" style="width: 100%; height: 350px;"></div>
               <h4>Contribution per country</h4>
                <div style="height: 900px">
                  <canvas id="statistics_country_contribution"></canvas>
                  <canvas id="statistics_country_contribution_count"></canvas>
                  <canvas id="statistics_length_distribution"></canvas>
                  <canvas id="statistics_tags_per_track"></canvas>
                </div>

            </div>
            <div class="sidebar-pane" id="about">
                <h1 class="sidebar-header">About<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h3>Partners and support</h3>
                <p><span style="font-weight: bold;">NoiseCapture </span>is a collaboration between two french research laboratories, the <a title="LAE website" href="http://www.lae.ifsttar.fr">Environmental
            Acoustic Laboratory</a> (Ifsttar) and the DECIDE team of the <a title="Lab-STICC website" href="http://www.lab-sticc.fr/">Lab-STICC</a> (CNRS), as a part of the european
                    <b> </b><a href="http://www.energic-od.eu/">ENERGIC-OD</a><b> </b>research project, and is supported by the French geographic portal <a href="http://www.geopal.org">GEOPAL
            </a>of the Pays de la Loire region.
                </p>
                <br>
                <div class="centered">
                    <div>
                        <a target="_blank" href="http://www.lae.ifsttar.fr"><img class="authorlogo" title="Ifsttar logo" alt="Ifsttar logo" src="img/IFSTTAR_logo_quadri.jpg"></a>
                        <a target="_blank" href="http://www.lab-sticc.fr"><img class="authorlogo" title="CNRS logo" alt="CNRS logo" src="img/CNRSfr-grand.png" height="50%"></a>
                    </div>
                    <div>
                        <a target="_blank" href="http://www.energic-od.eu/"><img class="orglogo" title="ENERGIC-OD logo" alt="ENERGIC-OD logo" src="img/logo_EnergicOD_HD.png"></a>
                        <a target="_blank" href="https://europa.eu/"><img class="orglogo" title="Europa logo" alt="Europa logo" src="img/Logo_EUROPE.png"></a>
                        <a target="_blank" href="http://www.geopal.org"><img class="orglogo" title="GEOPAL logo" alt="GEOPAL logo" src="img/Logo_GEOPAL.png"></a>
                    </div>
                </div>
                <h4>Follow us</h4>
                <a target="_blank" href="https://twitter.com/search?q=%40Noise_planet&src=typd"><img title="Follow @Noise_Planet" alt="Follow @Noise_Planet" src="https://img.shields.io/twitter/follow/Noise_Planet.svg?style=social&amp;label=Follow" /></a>
                <a target="_blank" href="https://github.com/Ifsttar/NoiseCapture/subscription"> <img title="Watch NoiseCapture" alt="Watch NoiseCapture" src="https://img.shields.io/github/watchers/ifsttar/noisecapture.svg?style=social&amp;label=Watch" /></a>
                <h4>Contact us</h4>
                <p>For any questions involving the project and the data, please contact us at <a title="mailt ot: noisecapture@noise-planet.org" href="mailto:noisecapture@noise-planet.org">noisecapture(at)noise-planet.org</a>
                </p>
                <h3>Website content</h3>
                <p>The NoiseCapture website is a publication of the Ifsttar (French Institute of Science and Technology devoted to Transport, Planning and Networks) and of the CNRS (Centre national de la recherche scientifique). The website is hosted and
                    maintained by Ifsttar and CNRS. Unless specified otherwise, the content on this website is properties of Ifsttar and CNRS.
                </p>
                <h3>Licenses</h3>
                <h4>NoiseCapture Android App</h4>
                <p>NoiseCapture Android App is a free software; you can redistribute it and/or modify it under the terms of the <a title="GPLv3" href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU
            General Public License</a> as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version.<br>
                </p>
                <h4>Collected raw data</h4>
                <p>All raw data collected from the NoiseCapture Android App, i.e. the DATABASE-NoiseCaptureRaw, are made available under the <a href="http://opendatacommons.org/licenses/odbl/1.0/">Open Database
            License</a>. Any rights in individual contents of the database are licensed under the
                    <a href="http://opendatacommons.org/licenses/odbl/1.0/">Database Contents License</a>.
                </p>
                <h4>Disclaimer</h4>
                <p>The data provided on this site result from a research project. It has no legal force and serves for information purposes only.

Absolutely no accuracy or completeness guarantee is implied or intended.

The authors are not responsible for the direct or indirect consequences of the uses or interpretation of the information provided.</p>
            </div>
            <div class="sidebar-pane" id="hexainfo">
                <h1 class="sidebar-header">Selected area<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

                <h3>Explore the mean noise of your environment</h3>
                <div class="defindicator">The <b>LA50</b> is the A-weighted noise level that is exceeded for 50% of the measurement period. It is a good descriptor of the perceived sound level in the environment.</div>
                <div class="defindicator">The <b>LAeq</b> is the A-weighted noise level. It is a standard descriptor of the perceived sound level in the environment.</div>
                <hr style='margin-bottom=0em'>
                <div id="areainfo"></div>
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#la50">LA50</a></li>
                    <!--<li><a data-toggle="tab" href="#lden">Lden</a></li>-->
                    <li><a data-toggle="tab" href="#laeq">LAeq</a></li>
                </ul>
                <div class="tab-content">
                    <div id="la50" class="tab-pane fade in active">
                        <img align="right" style="margin:5px 5px" src="http://onomap-gs.noise-planet.org/geoserver/gwc/service/wms?REQUEST=GetLegendGraphic&VERSION=1.3.0&FORMAT=image/png&LAYER=noisecapture:noisecapture_area&legend_options=fontName:Cerdana;fontAntiAliasing:true;fontColor:0x000033;fontSize:12;dpi:80&TRANSPARENT=true"
                        />



                        <div class="defindicator">The following 'time-donuts' show the <b>temporal evolution of the LA50</b> over the 24h of a day, for a working day, the Saturday and the Sunday. For each 1h-period (0:00-1:00, for the 1st period...), the LA50 is evaluated from
                            the measurments. See the help section for more information.</div>
                        <div>
                            <div class="donut_block">
                                <h3 class='attribute_label'>Working days</h3>
                                <div id="donut_working_day_la50" class="sidepanel_donut"></div>
                            </div>
                            <div class="donut_block">
                                <h3 class='attribute_label'>Saturday</h3>
                                <div id="donut_saturday_la50" class="sidepanel_donut"></div>
                            </div>
                            <div class="donut_block">
                                <h3 class='attribute_label'>Sunday</h3>
                                <div id="donut_sunday_la50" class="sidepanel_donut"></div>
                            </div>
                        </div>
            </div>

                            <div id="laeq" class="tab-pane fade in">

                                <img align="right" style="margin:5px 5px" src="http://onomap-gs.noise-planet.org/geoserver/gwc/service/wms?REQUEST=GetLegendGraphic&VERSION=1.3.0&FORMAT=image/png&LAYER=noisecapture:noisecapture_area&legend_options=fontName:Cerdana;fontAntiAliasing:true;fontColor:0x000033;fontSize:12;dpi:80&TRANSPARENT=true"
                                />



                                <div class="defindicator">The following 'time-donuts' show the <b>temporal evolution of the LAeq</b> over the 24h of a day, for a working day, the Saturday and the Sunday. For each 1h-period (0:00-1:00, for the 1st period...), the LAeq is evaluated from
                                    the measurments. See the help section for more information.</div>
                                <div>
                                    <div class="donut_block">
                                        <h3 class='attribute_label'>Working days</h3>
                                        <div id="donut_working_day_laeq" class="sidepanel_donut"></div>
                                    </div>
                                    <div class="donut_block">
                                        <h3 class='attribute_label'>Saturday</h3>
                                        <div id="donut_saturday_laeq" class="sidepanel_donut"></div>
                                    </div>
                                    <div class="donut_block">
                                        <h3 class='attribute_label'>Sunday</h3>
                                        <div id="donut_sunday_laeq" class="sidepanel_donut"></div>
                                    </div>
                                </div>
                    </div>
                    <div id="lden" class="tab-pane fade">
                        <h3>Menu 1</h3>
                        <p>Some content in menu 1.</p>
                    </div>
                    <div id="leq" class="tab-pane fade">
                        <h3>Menu 2</h3>
                        <p>Some content in menu 2.</p>
                    </div>
                </div>
            </div>
            <div class="sidebar-pane" id="help">
                <h1 class="sidebar-header">Help<span class="sidebar-close"><i class="fa-question-circle"></i></span></h1>
                <p>TODO.</p>
            </div>
            <div class="sidebar-pane" id="code">
                <h1 class="sidebar-header">Contributing<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h3> <span style="font-weight: bold;">Code developement</span></h3>
                <h2><span style="font-weight: bold;"></span></h2>
                <p>As an open source project, there are many ways to contribute to the development of NoiseCapture.</p>
                <h4>Fork the project on GitHub, develop and report issues</h4>
                <p>NoiseCapture uses the GitHub code hosting platform.
                    <a target="_blank" title="NoiseCapture on GitHub" href="https://github.com/ifsttar/noisecapture">https://github.com/ifsttar/noisecapture</a>
                </p>
                <a target="_blank" href="https://github.com/ifsttar/noisecapture/fork"><img title="Fork NoiseCapture" alt="Fork NoiseCapture" src="https://img.shields.io/github/forks/ifsttar/noisecapture.svg?style=social&amp;label=Fork"></a>
                <a target="_blank" href="https://github.com/Ifsttar/NoiseCapture/issues"><img title="NoiseCapture issues" alt="NoiseCapture issues" src="https://img.shields.io/github/issues/ifsttar/noisecapture.svg"></a>
                <h4>Translate NoiseCapture App to your language</h4>
                <p>NoiseCapture uses Transifex as translation plateform.
                    <a target="_blank" title="Translation" href="https://www.transifex.com/LAE/noisecapture">https://www.transifex.com/LAE/noisecapture</a>
                </p>
            </div>
            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <!-- http://usrz.github.io/bootstrap-languages/ -->
                <!--  -->
                <h4>Time format language:</h4>
                <div class="btn-group dropdown">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <span id="time_lang" class="lang-sm lang-lbl-full" lang="en"></span> <span class="caret"></span>
            </button>
                    <ul id="time_lang_list" class="dropdown-menu" role="menu">
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="bg"></span></a></li>
                        <!-- Bulgarian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="hr"></span></a></li>
                        <!-- Croatian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="cs"></span></a></li>
                        <!-- Czech -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="da"></span></a></li>
                        <!-- Danish -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="nl"></span></a></li>
                        <!-- Dutch -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="en"></span></a></li>
                        <!-- English -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="el"></span></a></li>
                        <!-- Croatian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="et"></span></a></li>
                        <!-- Estonian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="fi"></span></a></li>
                        <!-- Finish -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="fr"></span></a></li>
                        <!-- French -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="de"></span></a></li>
                        <!-- German -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="el"></span></a></li>
                        <!-- Greek -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="hu"></span></a></li>
                        <!-- Hungarian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="ga"></span></a></li>
                        <!-- Irish -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="it"></span></a></li>
                        <!-- Italian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="lv"></span></a></li>
                        <!-- Latvian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="lt"></span></a></li>
                        <!-- Lithuanian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="mt"></span></a></li>
                        <!-- Maltese -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="pl"></span></a></li>
                        <!-- Polish -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="pt"></span></a></li>
                        <!-- Portuguese -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="ro"></span></a></li>
                        <!-- Romanian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="sk"></span></a></li>
                        <!-- Slovak -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="sl"></span></a></li>
                        <!-- Slovenian -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="es"></span></a></li>
                        <!-- Spanish -->
                        <li><a role="menuitem" tabindex="-1"><span class="lang-sm lang-lbl-full" lang="sv"></span></a></li>
                        <!-- Swedish -->
                    </ul>
                </div>
                <h4>Time format zone:</h4>
                <label class="radio-inline"><input type="radio" name="tz-option"> Browser timezone</label><br>
                <label class="radio-inline"><input onsite type="radio" name="tz-option" checked> Measurement location timezone</label>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="js/time_donut.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/proj4.js"></script>
    <script src="js/L.TileLayer.OnoMap.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/leaflet-sidebar.js"></script>
    <script src="js/cluster.js"></script>
    <script src="js/leaflet.wms.js"></script>
    <script src="js/leaflet-search.min.js"></script>
    <script src="js/moment-with-locales.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/leaflet.awesome-markers.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/L.Control.MousePosition.js"></script>
    <script src="js/jqcloud-1.0.4.min.js"></script>
    <script>
    var colorMap = ["#a6cee3", "#ffffbf" , "#b2df8a" , "#fb9a99" , "#fdbf6f" , "#ff7f00" , "#cab2d6" , "#6a3d9a"
                    , "#ffff99" , "#b15928"];

    var map = L.map('map').setView([47.175, 12.524], 5);

    var sidebar = L.control.sidebar('sidebar').addTo(map);

    var osm = L.tileLayer('http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    });

    var esriworldimagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    var onomap = L.tileLayer.OnoMap('http://onomap-gs.noise-planet.org/geoserver/gwc/service/tms/1.0.0/noisecapture:noisecapture_area@EPSG:900913@png/{z}/{x}/{y}.png', {
      "attribution": "<a href='http://onomap-gs.noise-planet.org'>OnoMap server</a>",
      tms: true,
      minZoom: 14
    });

    var onomap_pt = L.tileLayer('http://onomap-gs.noise-planet.org/geoserver/gwc/service/tms/1.0.0/noisecapture:noisecapture_leaflet_point@EPSG:900913@png/{z}/{x}/{y}.png', {
      "attribution": "<a href='http://onomap-gs.noise-planet.org'>OnoMap server</a>",
      tms: true,
      minZoom: 14
    });


    var onomap_cluster_layer = L.geoJSON.OnoMap('http://onomap-gs.noise-planet.org/geoserver/ows');

    L.control.scale({
      'position': 'bottomright',
      'metric': true,
      'imperial': false
    }).addTo(map);

    L.control.mousePosition().addTo(map);

    new L.Control.Search({
      url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
      jsonpParam: 'json_callback',
      propertyName: 'display_name',
      propertyLoc: ['lat', 'lon'],
      markerLocation: true,
      autoType: false,
      autoCollapse: true,
      minLength: 2,
      zoom: 15
    }).addTo(map);

    map.addLayer(osm)
    map.addLayer(onomap)
    map.addLayer(onomap_cluster_layer)

    var baseLayers = {
      "OpenStreetMap": osm,
      "Images satellites": esriworldimagery
    };

    L.control.layers(baseLayers, {
      "Sound level (LA50)": onomap,
      "Density of measures": onomap_cluster_layer,
      "Location of measures": onomap_pt
    }).addTo(map);

    var hash = new L.Hash(map);

    var weekdonut = initTimeDonut("donut_working_day");
    var saturdaydonut = initTimeDonut("donut_saturday");
    var sundaydonut = initTimeDonut("donut_sunday");

    // Load default donuts
    onomap.showGetFeatureInfo(null, null, []);

    function doHistoRefresh() {
      onomap.getHistory();
    }

    function length_to_dd_hh_mm_ss(seconds) {
      if (seconds == 0) {
        return "0s";
      }
      // calculate (and subtract) whole days
      var days = Math.floor(seconds / 86400);
      seconds -= days * 86400;

      // calculate (and subtract) whole hours
      var hours = Math.floor(seconds / 3600) % 24;
      seconds -= hours * 3600;

      // calculate (and subtract) whole minutes
      var minutes = Math.floor(seconds / 60) % 60;
      seconds -= minutes * 60;

      // what's left is seconds
      var seconds = seconds % 60; // in theory the modulus is not required
      if (days > 0) {
        return days + "d " + hours + "h" + minutes + "m"
      } else if (hours > 0) {
        return hours + "h" + minutes + "m";
      } else if (minutes > 0) {
        return minutes + "m" + seconds + "s";
      } else {
        return seconds + "s";
      }
    }

    function loadStatistics() {
      // Test if statistics are aloready loaded
      if (typeof window.statisticsCountryContributionBar !== 'undefined') {
        return;
      }
      // Retrieve stored statistics file
      $.ajax({
        url: "http://data.noise-planet.org/statistics.json",
        type: "GET",
        crossDomain: true,
        cache: false,
        dataType: "json",
        success: function(data) {
          document.getElementById('statistics_week_new_contributors').innerHTML = data["week_new_contributors"];
          document.getElementById('statistics_week_new_tracks_count').innerHTML = data["week_new_tracks_count"];
          document.getElementById('statistics_week_new_tracks_duration').innerHTML = length_to_dd_hh_mm_ss(data["week_new_tracks_duration"]);

          document.getElementById('statistics_total_contributors').innerHTML = data["total_contributors"];
          document.getElementById('statistics_total_tracks').innerHTML = data["total_tracks"];
          document.getElementById('statistics_total_tracks_duration').innerHTML = length_to_dd_hh_mm_ss(data["total_tracks_duration"]);

          // Load tags
          $("#statistics_world_tags").jQCloud(data["tags"]);

          // Load contribution per country
          // Sort arrays by track_length
          var name_sorted = data["countries"]["names"].slice()
          var count_sorted = data["countries"]["track_length"].slice()
          window.statisticsCountryContributionBar =  new Chart(document.getElementById("statistics_country_contribution"), {
            type: 'horizontalBar',
            data: {
              labels: name_sorted.sort(function(a,b) {return data["countries"]["track_length"][data["countries"]["names"].indexOf(b)] - data["countries"]["track_length"][data["countries"]["names"].indexOf(a)]}).slice(0, Math.min(8, data["countries"]["names"].length)),
              datasets: [{
                  label: 'Mesurements',
                  backgroundColor: "#d1e5f0",
                  borderColor: "#67a9cf",
                  borderWidth: 1,
                  data: count_sorted.sort(function(a, b){return b-a}).slice(0, Math.min(8, data["countries"]["track_length"].length))
              }]
            },
            options: {
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    rectangle: {
                        borderWidth: 2,
                    }
                },
                responsive: true,
                tooltips: {
                  mode: 'index',
                  intersect: true,
                  callbacks: {
                    label: function(tooltipItem, data) {
                      return data.datasets[tooltipItem.datasetIndex].label + ': ' + length_to_dd_hh_mm_ss(tooltipItem.xLabel);
                    }
                  }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Sum of measurements length'
                },
                scales: {
                  xAxes: [{
                    time: {
                      unit: 'second'
                    },
                    ticks: {
                      userCallback: function(v) {
                        return length_to_dd_hh_mm_ss(v)
                      }
                    }
                  }]
                }
            }
          });


          // Load contribution per country
          window.statistics_country_contribution_count =  new Chart(document.getElementById("statistics_country_contribution_count"), {
            type: 'horizontalBar',
            data: {
              labels: data["countries"]["names"].slice(0, Math.min(8, data["countries"]["names"].length)),
              datasets: [{
                  label: 'Mesurements',
                  backgroundColor: "#d1e5f0",
                  borderColor: "#67a9cf",
                  borderWidth: 1,
                  data: data["countries"]["total_tracks"].slice(0, Math.min(8, data["countries"]["total_tracks"].length))
              }]
            },
            options: {
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    rectangle: {
                        borderWidth: 2,
                    }
                },
                responsive: true,
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Number of measurements'
                }
            }
          });

          // Load country/week stack bar
          window.statisticsCountryWeeksBar = new Chart(document.getElementById("statistics_country_weeks"), {
            type: 'bar',
            data: data["week_tracks"],
            options: {
              maintainAspectRatio: false,
              title: {
                display: true,
                text: "Measurements duration by week"
              },
              tooltips: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(tooltipItem, data) {
                    return data.datasets[tooltipItem.datasetIndex].label + ': ' + length_to_dd_hh_mm_ss(tooltipItem.yLabel);
                  }
                }
              },
              responsive: true,
              scales: {
                xAxes: [{
                  stacked: true,
                }],
                yAxes: [{
                  stacked: true,
                  //type: "logarithmic",
                  time: {
                    unit: 'second'
                  },
                  ticks: {
                    userCallback: function(v) {
                      return length_to_dd_hh_mm_ss(v)
                    }
                  }
                }]
              }
            }
          });

          // Load measurementslength distribution
          // Bar chart
          new Chart(document.getElementById("statistics_length_distribution"), {
              type: 'bar',
              data: {
                labels: data["distribution_measurements"]["ranges"],
                datasets: [
                  {
                    label: "Measurement count",
                    backgroundColor: "#d1e5f0",
                    borderColor: "#67a9cf",
                    data: data["distribution_measurements"]["total_tracks"]
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Measurement length distribtion'
                }
              }
          });



          // Load measurementslength distribution
          // Bar chart
          new Chart(document.getElementById("statistics_tags_per_track"), {
              type: 'bar',
              data: {
                labels: data["tags_per_track"]["tag_count"],
                datasets: [
                  {
                    label: "Measurement count",
                    backgroundColor: "#d1e5f0",
                    borderColor: "#67a9cf",
                    data: data["tags_per_track"]["track_count"],
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Distribution of tags per measurement'
                },
                tooltips: {
                  callbacks: {
                    title: function(tooltipItems, data) {
                        //Return value for title
                        return tooltipItems[0].xLabel + '  tags';
                    }
                  }
                }
              }
          });

        }
      });
    }
    </script>
</body>

</html>
